<?xml version="1.0"?>

<project name="OpenSextant-Gazetteer" default="index">

    <property name="csv.file" location="MergedGazetteer-20130725-v15a.txt" />

    <!-- Solr config & data (this is the standard System property name Solr uses) -->
    <property name="solr.solr.home" location="." />

    <property name="solr.v" value="4.2.1" />
    <!-- a small servlet engine -->
    <property name="winstone.v" value="0.9.10-hudson-24" />
    <property name="textTagger.v" value="1.2-SNAPSHOT" />

    <!-- get some dependencies -->
    <get skipexisting="true" dest=".">
        <url url="http://repo1.maven.org/maven2/org/apache/solr/solr/${solr.v}/solr-${solr.v}.war" />
        <url url="http://repo1.maven.org/maven2/org/jvnet/hudson/winstone/winstone/${winstone.v}/winstone-${winstone.v}.jar" />
    </get>

    <!-- get text tagger in first available of local maven repo, snapshot repo, maven central -->
    <copy todir="lib" overwrite="false" failonerror="false"
          file="${user.home}/.m2/repository/org/opensextant/solr-text-tagger/${textTagger.v}/solr-text-tagger-${textTagger.v}.jar"
           />
    <get dest="lib" skipexisting="true" ignoreerrors="true">
        <url url="https://oss.sonatype.org/content/repositories/snapshots/org/opensextant/solr-text-tagger/${textTagger.v}/solr-text-tagger-${textTagger.v}.jar" />
        <url url="http://repo1.maven.org/maven2/org/opensextant/solr-text-tagger/${textTagger.v}/solr-text-tagger-${textTagger.v}.jar" />
    </get>

    <!-- TARGETS: -->

    <target name="clean" description="Delete indexed data">
        <delete dir="${solr.solr.home}/gazetteer/data/" />
    </target>

    <target name="_index">
        <available property="csvFile.exists" file="${csv.file}" />
        <fail unless="csvFile.exists" message="The CSV file doesn't exist: ${csv.file}" />
        <get
            src="http://localhost:8983/solr/gazetteer/updateGazCsv?optimize=true&amp;stream.file=${csv.file}&amp;update.contentType=text/csv"
            dest="${java.io.tmpdir}/update-csv.response.xml" />

        <echo message="Building FST..." />
        <get src="http://localhost:8983/solr/gazetteer/tag?build=true"
            dest="${java.io.tmpdir}/build-fst.response.xml" />
    </target>

    <target name="index" depends="start-solr-daemon, _index, stop-solr" description="Starts Solr, indexes data, then stops it">
    </target>

    <target name="start-solr-daemon">
        <parallel>
            <daemons>
                <exec-solr />
            </daemons>
        </parallel>

        <echo message="Waiting for Solr to start by checking its URL..." />
        <waitfor maxwait="10" maxwaitunit="second" checkevery="500" timeoutproperty="solr.failed">
            <http url="http://localhost:8983/solr/gazetteer/select" />
        </waitfor>
        <fail if="solr.failed" message="Solr did not properly start, probably due to a configuration error." />
    </target>

    <macrodef name="exec-solr">
        <sequential>
            <!-- 2 GB to build current gazetteer with 13 million rows -->
            <java jar="winstone-${winstone.v}.jar" fork="true" clonevm="true" failonerror="true"
                  maxmemory="2G">
                <sysproperty key="java.awt.headless" value="true" />
                <sysproperty key="solr.solr.home" value="${solr.solr.home}" />
                <sysproperty key="solr.enableRemoteStreaming" value="true" />
                <sysproperty key="java.util.logging.config.file" value="logging.properties" />
                <arg value="--controlPort=8081" />
                <arg value="--commonLibFolder=none" /><!-- default 'lib' conflicts with Solr -->
                <arg value="--httpPort=8983" />
                <arg value="--warfile=solr-${solr.v}.war" />
                <arg value="--prefix=/solr" />
            </java>
        </sequential>
    </macrodef>

    <target name="start-solr" description="Start Solr (Winstone) on port 8983. Stop it via stop-solr.">
        <exec-solr />
    </target>

    <target name="stop-solr" description="Shut down Solr (Winstone)">
        <java classpath="winstone-${winstone.v}.jar" classname="winstone.tools.WinstoneControl">
            <!-- by default, port 8081 -->
            <arg value="shutdown" />
        </java>
    </target>

</project>
